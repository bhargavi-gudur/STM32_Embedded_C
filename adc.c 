/******************************************************************************
 * File Name : adc_pwm_control.c
 * Date      : 12 January 2026
 * Author    : Gandla Bhargavi
 *
 * Description:
 * This program reads an analog voltage using ADC Channel 22 and generates
 * a 100 Hz PWM signal on GPIOA Pin 7 using Timer 3. The duty cycle of the PWM
 * varies based on the ADC value, allowing control of LED brightness or motor
 * speed.
 ******************************************************************************/

#include "stm32l1xx.h"

/* ---------------- Global Variables ---------------- */
uint16_t adcValue = 0;

/* ---------------- Function Prototypes ---------------- */
void GPIO_Config(void);
void ADC_Config(void);
void TIM3_Config(void);
void PWM_Update(void);

/* ---------------- Main Function ---------------- */
int main(void)
{
    GPIO_Config();
    ADC_Config();
    TIM3_Config();

    while(1)
    {
        PWM_Update();
    }
}

/* ---------------- GPIO Configuration ---------------- */
void GPIO_Config(void)
{
    RCC->AHBENR |= (1 << 0);   // Enable GPIOA
    RCC->AHBENR |= (1 << 4);   // Enable GPIOE

    // Configure PA7 as output
    GPIOA->MODER |= (1 << 14);
    GPIOA->OTYPER |= (1 << 7);
    GPIOA->PUPDR |= (1 << 14);

    // Configure GPIOE for analog input (ADC)
    GPIOE->MODER |= (1 << 14) | (1 << 15);

    // Configure ADC channel pin
    GPIOE->MODER |= (1 << 8);
    GPIOE->OTYPER &= ~(1 << 4);
    GPIOE->ODR |= (1 << 4);
}

/* ---------------- ADC Configuration ---------------- */
void ADC_Config(void)
{
    RCC->APB2ENR |= (1 << 9);  // Enable ADC1
    RCC->CR |= (1 << 0);      // Enable HSI clock

    ADC1->CR2 |= (1 << 0);    // ADC ON
    ADC1->SMPR3 |= (1 << 23) | (1 << 22) | (1 << 21);
    ADC1->CR2 &= ~(1 << 1);   // Single conversion mode
    ADC1->SQR1 |= (0 << 20);  // One conversion in sequence
    ADC1->SQR5 |= 22;         // ADC Channel 22
    ADC1->CR2 |= (1 << 30);   // Start ADC conversion
}

/* ---------------- Timer 3 Configuration ---------------- */
void TIM3_Config(void)
{
    RCC->APB1ENR |= (1 << 1);  // Enable TIM3 clock

    TIM3->CR1 |= (1 << 7);    // Enable auto-reload
    TIM3->ARR = 21000;       // Set PWM period for 100 Hz
    TIM3->CNT = 0;           // Reset counter
    TIM3->CR1 |= (1 << 0);   // Start timer
}

/* ---------------- PWM Update Function ---------------- */
void PWM_Update(void)
{
    float onTime;

    if (ADC1->SR & (1 << 1))   // Check ADC conversion complete
    {
        adcValue = ADC1->DR;  // Read ADC value

        // Convert ADC value (0–4095) to ON time (0–21000)
        onTime = adcValue * 10.3448;

        if (TIM3->CNT <= onTime)
            GPIOA->ODR |= (1 << 7);    // Output ON
        else
            GPIOA->ODR &= ~(1 << 7);   // Output OFF

        ADC1->CR2 |= (1 << 30);        // Start next ADC conversion
    }
}